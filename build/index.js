(()=>{"use strict";const e=window.React,t=window.wp.hooks,o=window.wp.compose,r=window.wp.data,n=window.wp.blockEditor,l=window.wp.components,p=window.wp.i18n,s=window.wp.element,a=(0,s.createContext)({postTemplates:[]});(0,t.addFilter)("blocks.registerBlockType","hm-query-loop/add-query-loop-attributes",function(e,t){return"core/query"!==t?e:{...e,attributes:{...e.attributes,hmQueryLoop:{type:"object",default:{}}},providesContext:{...e.providesContext||{},"hm-query-loop/settings":"hmQueryLoop"}}}),(0,t.addFilter)("blocks.registerBlockType","hm-query-loop/add-post-template-context",function(e,t){return"core/post-template"!==t?e:{...e,attributes:{...e.attributes,hmQueryLoop:{type:"object",default:{}}},usesContext:[...e.usesContext||[],"hm-query-loop/settings"]}});const i=(0,o.createHigherOrderComponent)(t=>o=>{const{name:r,attributes:a,setAttributes:i}=o;if("core/query"!==r)return(0,e.createElement)(t,{...o});const{hmQueryLoop:c={},query:u={}}=a,{perPage:m,hideOnPaged:d,excludeDisplayed:h}=c,y=u.inherit||!1,g=window.hmQueryLoopSettings?.postsPerPage||10;return(0,s.useEffect)(()=>{void 0!==m&&m>0&&u.perPage!==m&&i({query:{...u,perPage:m}})},[m]),(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...o}),(0,e.createElement)(n.InspectorControls,null,(0,e.createElement)(l.PanelBody,{title:(0,p.__)("Extra Query Loop Settings","hm-query-loop"),initialOpen:!1},y&&(0,e.createElement)(l.TextControl,{label:(0,p.__)("Posts per page (Override)","hm-query-loop"),help:(0,p.__)("Override the number of posts to show when inheriting the query. Maximum value is limited to the site's posts per page setting.","hm-query-loop"),type:"number",value:null!=m?m:"",onChange:e=>{const t=""===e?void 0:parseInt(e,10);i({hmQueryLoop:{...c,perPage:t}})},min:1,max:g}),!y&&m&&(0,e.createElement)("p",{style:{fontSize:"12px",color:"#757575"}},(0,p.__)("Posts per page override is only available when inheriting the query.","hm-query-loop")),(0,e.createElement)(l.ToggleControl,{label:(0,p.__)("Hide on paginated pages","hm-query-loop"),help:(0,p.__)("Hide this query loop when viewing page 2 or higher.","hm-query-loop"),checked:d,onChange:e=>i({hmQueryLoop:{...c,hideOnPaged:e}})}),(0,e.createElement)(l.ToggleControl,{label:(0,p.__)("Exclude already displayed posts","hm-query-loop"),help:(0,p.__)("Exclude posts that have been displayed by previous query loops on this page.","hm-query-loop"),checked:h,onChange:e=>i({hmQueryLoop:{...c,excludeDisplayed:e}})}))))},"withInspectorControls");(0,t.addFilter)("editor.BlockEdit","hm-query-loop/with-inspector-controls",i);const c=(0,o.createHigherOrderComponent)(t=>o=>{const{name:r,attributes:s,setAttributes:a,context:i}=o;if("core/post-template"!==r)return(0,e.createElement)(t,{...o});const{hmQueryLoop:c={}}=s,{perPage:u}=c,m=(i?.query||{}).inherit||!1,d=i?.query?.perPage||window.hmQueryLoopSettings?.postsPerPage||10;return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...o}),!m&&(0,e.createElement)(n.InspectorControls,null,(0,e.createElement)(l.PanelBody,{title:(0,p.__)("Post Template Settings","hm-query-loop"),initialOpen:!1},(0,e.createElement)(l.TextControl,{label:(0,p.__)("Posts per template","hm-query-loop"),help:(0,p.__)("Set the number of posts to show in this post template block. Leave empty to show all remaining posts.","hm-query-loop"),type:"number",value:null!=u?u:"",onChange:e=>{const t=""===e?void 0:parseInt(e,10);a({hmQueryLoop:{...c,perPage:t}})},min:1,max:d}))))},"withPostTemplateInspectorControls");(0,t.addFilter)("editor.BlockEdit","hm-query-loop/with-post-template-inspector-controls",c);const u=(0,o.createHigherOrderComponent)(t=>o=>{const{name:n,clientId:l}=o;if("core/query"!==n)return(0,e.createElement)(t,{...o});const p=(0,r.useSelect)(e=>{const{getBlock:t,getBlocksByName:o,getBlockParentsByBlockName:r}=e("core/block-editor");return o("core/post-template").filter(e=>r(e,"core/query").indexOf(l)>-1).map(t)},[l]);return(0,e.createElement)(a.Provider,{value:{postTemplates:p}},(0,e.createElement)(t,{...o}))},"withQueryLoopContextProvider");(0,t.addFilter)("editor.BlockEdit","hm-query-loop/with-query-loop-context-provider",u);const m=(0,o.createHigherOrderComponent)(t=>o=>{const{name:r,context:n,clientId:l,attributes:p}=o;if("core/post-template"!==r)return(0,e.createElement)(t,{...o});const i=(n?.["hm-query-loop/settings"]||{}).perPage;let c=(p?.hmQueryLoop||{}).perPage||i;const{postTemplates:u}=(0,s.useContext)(a);let m=0;for(const e of u){if(e.clientId===l)break;m+=e.attributes?.hmQueryLoop?.perPage||0}const d=`[data-block="${l}"]`,h=(m>0?`\n\t\t\t${d} :is(.wp-block-post:not([style*="display: none"])):nth-of-type(-n+${m}) {\n\t\t\t\tdisplay: none !important;\n\t\t\t}\n\t\t`:"")+`\n\t\t\t${d} :is(.wp-block-post:not([style*="display: none"])):nth-of-type(n+${m+c+2}) {\n\t\t\t\tdisplay: none !important;\n\t\t\t}\n\t\t`+(m>0?`\n\t\t\t${d}:has(.wp-block-post[data-is-drop-zone]:first-child) :is(.wp-block-post:not([style*="display: none"])):nth-of-type(-n+${m+1}) {\n\t\t\t\tdisplay: none !important;\n\t\t\t}\n\t\t`:"");return(0,e.createElement)(e.Fragment,null,(0,e.createElement)("style",null,h),(0,e.createElement)(t,{...o}))},"withPostTemplateStyles");(0,t.addFilter)("editor.BlockEdit","hm-query-loop/with-post-template-styles",m),(0,t.addFilter)("blocks.getSaveContent.extraProps","hm-query-loop/add-save-props",function(e,t,o){return t.name,e})})();